generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model CodigoVerificacionMCP {
  id         Int      @id @default(autoincrement())
  usuarioId  Int
  codigo     String   @db.VarChar(6)
  expiraEn   DateTime
  verificado Boolean  @default(false)
  creadoEn   DateTime @default(now())

  @@index([usuarioId])
  @@index([codigo])
  @@map("codigos_verificacion_mcp")
}

model arbitro {
  id       Int     @id @default(autoincrement())
  nombres  String
  contacto String?
  partidos partido[]
}

model campeonato {
  id          Int       @id @default(autoincrement())
  nombre      String
  anio        Int
  fechaInicio DateTime
  fechaFin    DateTime?
  torneos     torneo[]
}

model cancha {
  id        Int     @id @default(autoincrement())
  nombre    String
  ubicacion String?
  partidos  partido[]
}

model equipo {
  id         Int     @id @default(autoincrement())
  nombre     String
  logoUrl    String?
  facultad   String?
  capitanId  Int
  disciplina String?
  genero     String? @default("MIXTO")
  codigoAcceso String?

  capitan    usuario @relation("EquipoCapitan", fields: [capitanId], references: [id])
  miembros   miembroequipo[]
  torneos    equipotorneo[]
  pagos      validacionpago[]
  partidosLocal     partido[] @relation("PartidoLocal")
  partidosVisitante partido[] @relation("PartidoVisitante")
}

model equipotorneo {
  id       Int    @id @default(autoincrement())
  equipoId Int
  torneoId Int
  estado   String @default("INSCRITO")

  equipo   equipo @relation(fields: [equipoId], references: [id])
  torneo   torneo @relation(fields: [torneoId], references: [id])

  @@unique([equipoId, torneoId], map: "EquipoTorneo_equipoId_torneoId_key")
  @@index([torneoId], map: "EquipoTorneo_torneoId_fkey")
  
  grupos grupo[]
}


model carrera {
  id         Int    @id @default(autoincrement())
  nombre     String
  facultadId Int

  facultad facultad  @relation(fields: [facultadId], references: [id])
  usuarios usuario[]

  @@unique([nombre, facultadId])
  @@index([facultadId], map: "Carrera_facultadId_fkey")
}

model facultad {
  id       Int       @id @default(autoincrement())
  nombre   String
  carreras carrera[]
}

model feedback {
  id        Int      @id @default(autoincrement())
  usuarioId Int?
  mensaje   String   @db.Text
  tipo      String
  fecha     DateTime @default(now())

  @@index([usuarioId], map: "Feedback_usuarioId_fkey")
}

model grupo {
  id             Int    @id @default(autoincrement())
  nombre         String
  equipoTorneoId Int

  equipoTorneo equipotorneo @relation(fields: [equipoTorneoId], references: [id])

  @@index([equipoTorneoId], map: "Grupo_equipoTorneoId_fkey")
}

model miembroequipo {
  id        Int @id @default(autoincrement())
  equipoId  Int
  usuarioId Int

  equipo  equipo  @relation(fields: [equipoId], references: [id])
  usuario usuario @relation(fields: [usuarioId], references: [id])

  @@unique([equipoId, usuarioId], map: "MiembroEquipo_equipoId_usuarioId_key")
  @@index([usuarioId], map: "MiembroEquipo_usuarioId_fkey")
}

model partido {
  id                 Int            @id @default(autoincrement())
  torneoId           Int
  canchaId           Int?
  arbitroId          Int?
  equipoLocalId      Int?
  equipoVisitanteId  Int?
  fechaHora          DateTime
  estado             partido_estado @default(PROGRAMADO)
  marcadorLocal      Int?           @default(0)
  marcadorVisitante  Int?           @default(0)
  fase               String?
  llave              String?
  siguientePartidoId Int?
  siguienteSlot      String?
  
  torneo          torneo     @relation(fields: [torneoId], references: [id])
  cancha          cancha?    @relation(fields: [canchaId], references: [id])
  arbitro         arbitro?   @relation(fields: [arbitroId], references: [id])
  equipoLocal     equipo?    @relation("PartidoLocal", fields: [equipoLocalId], references: [id])
  equipoVisitante equipo?    @relation("PartidoVisitante", fields: [equipoVisitanteId], references: [id])
  streaming       streaming?

  @@index([arbitroId], map: "Partido_arbitroId_fkey")
  @@index([canchaId], map: "Partido_canchaId_fkey")
  @@index([equipoLocalId], map: "Partido_equipoLocalId_fkey")
  @@index([equipoVisitanteId], map: "Partido_equipoVisitanteId_fkey")
  @@index([torneoId], map: "Partido_torneoId_fkey")
}

model sorteo {
  localId        Int
  visitanteId    Int
  canchaId       Int
  arbitroId      Int
  fechaEncuentro DateTime?
  sorteoCol      String?

  @@id([localId, visitanteId])
  @@index([arbitroId], map: "Sorteo_arbitroId_fkey")
  @@index([canchaId], map: "Sorteo_canchaId_fkey")
  @@index([visitanteId], map: "Sorteo_visitanteId_fkey")
}

model streaming {
  id        Int     @id @default(autoincrement())
  partidoId Int     @unique(map: "Streaming_partidoId_key")
  url       String
  isLive    Boolean @default(false)
  likes     Int     @default(0)
  views     Int     @default(0)
  partido   partido @relation(fields: [partidoId], references: [id])
}

model torneo {
  id               Int     @id @default(autoincrement())
  campeonatoId     Int
  disciplina       String
  categoria        String
  genero           String?
  tipoSorteo       String?
  configuracion    Json?
  costoInscripcion Decimal @default(0.000000000000000000000000000000)

  equiposInscritos equipotorneo[]
  pagos            validacionpago[]
  partidos         partido[]
  campeonato       campeonato       @relation(fields: [campeonatoId], references: [id])

  @@index([campeonatoId], map: "Torneo_campeonatoId_fkey")
}

model usuario {
  id        Int         @id @default(autoincrement())
  cedula    String      @unique(map: "Usuario_cedula_key")
  nombres   String
  apellidos String
  email     String      @unique(map: "Usuario_email_key")
  password  String
  rol       usuario_rol @default(ESTUDIANTE)
  genero    String?
  carreraId Int?
  createdAt DateTime    @default(now())
  ultimoLogin DateTime?
  chatBannedUntil DateTime?
  chatBanReason   String?

  carrera            carrera?         @relation(fields: [carreraId], references: [id])
  equiposCapitaneados equipo[]        @relation("EquipoCapitan")
  membresias          miembroequipo[]
  pagosRealizados     validacionpago[] @relation("UsuarioPago")
  pagosValidados      validacionpago[] @relation("ValidadoPor")
  notificaciones      Notificacion[]
  mensajesChat        MensajeChat[]
  passwordResetTokens PasswordResetToken[]

  @@index([carreraId], map: "Usuario_carreraId_fkey")
}

model validacionpago {
  id             Int                   @id @default(autoincrement())
  equipoId       Int
  usuarioPagoId  Int
  monto          Decimal
  comprobanteUrl String
  estado         validacionpago_estado @default(PENDIENTE)
  fechaSubida    DateTime              @default(now())
  validadoPorId  Int?
  observacion    String?
  torneoId       Int?

  equipo         equipo                @relation(fields: [equipoId], references: [id])
  usuarioPago    usuario               @relation("UsuarioPago", fields: [usuarioPagoId], references: [id])
  validadoPor    usuario?              @relation("ValidadoPor", fields: [validadoPorId], references: [id])
  torneo         torneo?               @relation(fields: [torneoId], references: [id])

  @@index([equipoId], map: "ValidacionPago_equipoId_fkey")
  @@index([torneoId], map: "ValidacionPago_torneoId_fkey")
  @@index([usuarioPagoId], map: "ValidacionPago_usuarioPagoId_fkey")
  @@index([validadoPorId], map: "ValidacionPago_validadoPorId_fkey")
}

enum validacionpago_estado {
  PENDIENTE
  VALIDADO
  RECHAZADO
}

enum usuario_rol {
  ADMIN
  CAPITAN
  ESTUDIANTE
}

enum partido_estado {
  PROGRAMADO
  EN_CURSO
  FINALIZADO
  CANCELADO
}

model Notificacion {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  mensaje   String
  leida     Boolean  @default(false)
  fecha     DateTime @default(now())
  tipo      String?
  link      String?

  usuario   usuario  @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId])
  @@map("notificaciones")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  token     String   @unique @db.VarChar(64)
  expiraEn  DateTime
  usado     Boolean  @default(false)
  creadoEn  DateTime @default(now())

  usuario   usuario  @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId])
  @@index([token])
  @@map("password_reset_tokens")
}

model MensajeChat {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  mensaje   String   @db.Text
  fecha     DateTime @default(now())
  sala      String   @default("general") // Para diferenciar chats (ej: por partido)

  usuario   usuario  @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId])
  @@index([sala])
  @@map("mensajes_chat")
}
